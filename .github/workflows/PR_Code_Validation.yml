name: PR Code Validation
on:
  workflow_dispatch:
  pull_request:
    branches:
      - dev
    paths:
      - 'src/main/default/**'
      - 'src-access-mgmt/main/default/**'
      - 'src-ui/main/default/**'            
      - '.github/workflows/Code_Validation_Commondev_Pool.yml'
      - '!sfdx-project.json'
jobs:
  Code-Validation-Run:
    runs-on: ubuntu-latest
    strategy:
      # By default, if any job in a matrix fails, all other jobs are immediately cancelled. This makes the jobs run to completion instead.
      fail-fast: false
    timeout-minutes: 60
    steps:
      # === Setup. We need to get the code, set up nodejs, and create the results directory. ===
      - uses: actions/checkout@v3
      - run: mkdir smoke-test-results
      # === Make three attempts to install sfdx ===
      - name: 'Install Salesforce CLI'
        run: |
          wget https://developer.salesforce.com/media/salesforce-cli/sfdx/channels/stable/sfdx-linux-x64.tar.xz
          mkdir ~/sfdx
          tar xJf sfdx-linux-x64.tar.xz -C ~/sfdx --strip-components 1
          echo "$HOME/sfdx/bin" >> $GITHUB_PATH
          ~/sfdx/bin/sfdx version

      # Authenticate CI01 sandbox
      - name: 'Authenticate CI01 Sandbox'
        run: |
            echo "${{ secrets.CI01_SFDXAUTHURL }}" > ./authfile
            sf org login sfdx-url -f authfile -a CI01

      - name: Validate Code
        id: run_code_validation
        run: sfdx force:source:deploy --sourcepath "src\main\default,src-access-mgmt\main\default,src-ui\main\default" --wait 60 --verbose --checkonly --testlevel RunLocalTests --targetusername CI01
